<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
		<title>Reactor Control</title>
		<script src="https://cdn.tailwindcss.com"></script>
		<style>
			:root {
				--green: #2ecc71; --dark-green: #16a085; --red: #e74c3c; --dark-bg: #1a1d22;
			}
			body { background-color: var(--dark-bg); font-family: 'Courier New', Courier, monospace; overscroll-behavior: none; }
			.terminal-glow { text-shadow: 0 0 5px var(--green), 0 0 10px var(--green); }
			.terminal-glow-red { text-shadow: 0 0 5px var(--red), 0 0 10px var(--red); }
			.scanlines::before {
				content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
				background: linear-gradient(to bottom, rgba(255,255,255,0) 0%, rgba(255,255,255,0.05) 50%, rgba(255,255,255,0) 100%);
				background-size: 100% 4px;
				animation: scan 10s linear infinite; pointer-events: none;
			}
			@keyframes scan { from { background-position: 0 0; } to { background-position: 0 -400px; } }
			@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
			@keyframes type { from { width: 0; } to { width: 100%; } }
			.animate-fadeIn { animation: fadeIn 1s ease-out forwards; }
			.animate-type { overflow: hidden; white-space: nowrap; animation: type 2s steps(40, end); }
			.location-btn:active { transform: scale(0.95); box-shadow: 0 0 15px var(--dark-green); }
			.minigame-btn:active { transform: scale(0.95); }
			.popup { transition: opacity 0.3s, transform 0.3s; }
			@keyframes shake {
				10%, 90% { transform: translate3d(-1px, 0, 0); }
				20%, 80% { transform: translate3d(2px, 0, 0); }
				30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
				40%, 60% { transform: translate3d(4px, 0, 0); }
			}
			.animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; }
		</style>
	</head>
	<body class="relative overflow-hidden">
		<div id="app" class="h-screen w-screen scanlines"></div>

		<!-- HTML templates remain the same -->
		<template id="boot-screen-template">
			<div class="flex flex-col items-center justify-center h-full w-full bg-black text-[var(--green)] p-4">
				<pre class="text-xl md:text-3xl terminal-glow mb-8 animate-fadeIn">R.C.S. HYPERION</pre>
				<div class="w-full max-w-md">
					<p id="boot-text" class="text-center animate-type"></p>
					<div class="w-full bg-gray-700 h-1 mt-2 rounded-full overflow-hidden"><div id="boot-progress" class="bg-[var(--green)] h-1 rounded-full" style="width: 0%; transition: width 4s linear;"></div></div>
				</div>
			</div>
		</template>
		<template id="main-screen-template">
			<main class="flex flex-col h-full p-6 text-[var(--green)] animate-fadeIn">
				<header class="border-b-2 border-[var(--green)] pb-4 text-center">
					<h1 id="player-action" class="text-2xl font-bold terminal-glow"></h1>
					<p id="player-role-desc" class="text-sm opacity-80 mt-2"></p>
				</header>
				<div class="flex-grow mt-6">
					<h2 class="text-lg mb-4 text-center">Select Target Location:</h2>
					<div id="location-buttons" class="grid grid-cols-2 gap-4"></div>
				</div>
			</main>
		</template>
		<template id="minigame-password-template">
			<div class="flex flex-col h-full p-6 text-[var(--green)] animate-fadeIn">
				<div class="relative flex-grow flex flex-col items-center justify-center bg-black/50 border-2 border-[var(--green)] rounded-lg p-4">
					<div id="minigame-timer" class="absolute top-2 right-2 text-2xl font-bold terminal-glow-red">10</div>
					<h2 id="minigame-prompt" class="text-xl text-center mb-6"></h2>
					<input id="password-input" type="text" class="w-full max-w-xs bg-transparent border-b-2 border-[var(--green)] text-center text-3xl p-2 text-[var(--green)] focus:outline-none focus:border-[var(--dark-green)]" autocomplete="off" />
					<button id="submit-minigame" class="mt-8 bg-[var(--green)] text-black font-bold py-3 px-12 rounded-lg text-xl location-btn">SUBMIT</button>
				</div>
			</div>
		</template>
		<template id="minigame-sequence-template">
			<div class="flex flex-col h-full p-6 text-[var(--green)] animate-fadeIn">
				<div class="relative flex-grow flex flex-col items-center justify-center bg-black/50 border-2 border-[var(--green)] rounded-lg p-4">
					<div id="minigame-timer" class="absolute top-2 right-2 text-2xl font-bold terminal-glow-red">15</div>
					<h2 id="minigame-prompt" class="text-xl text-center mb-6"></h2>
					<div id="sequence-display" class="w-full max-w-xs h-16 bg-black/50 border border-gray-600 rounded mb-6 flex items-center justify-center text-3xl space-x-2"></div>
					<div id="sequence-buttons" class="grid grid-cols-3 gap-4 w-full max-w-xs"></div>
					<button id="submit-minigame" class="mt-8 bg-[var(--green)] text-black font-bold py-3 px-12 rounded-lg text-xl location-btn">SUBMIT</button>
				</div>
			</div>
		</template>
		<template id="solution-popup-template">
			<div class="fixed top-4 right-4 z-50 w-11/12 max-w-sm bg-blue-900 border-2 border-blue-400 text-white rounded-lg shadow-lg p-4 opacity-0 transform translate-y-[-20px] popup">
				<button id="popup-close-btn" class="absolute top-1 right-2 text-2xl">&times;</button>
				<h3 class="font-bold text-lg mb-2 text-blue-300">[Incoming Transmission]</h3>
				<p id="solution-text" class="text-base"></p>
			</div>
		</template>

		<!-- ======================================================================== -->
		<!-- VANILLA JAVASCRIPT APPLICATION LOGIC (C# Naming Convention) -->
		<!-- ======================================================================== -->
		<script>
			// --- GLOBAL STATE ---
			let gameState = {
				currentScreen: 'BOOT',
				player: { id: 'player_123', action: null },
				minigame: { type: null, prompt: '', solution: null },
			};
			
			// --- STATE MANAGEMENT ---
			let subscribers = [];
			function Subscribe(callback) 
			{
				subscribers.push(callback);
				callback(null, gameState);
			}
			function UpdateState(updater) 
			{
				const oldState = { ...gameState };
				gameState = updater(gameState);
				subscribers.forEach(callback => callback(oldState, gameState));
			}

			// --- THE RENDERER ---
			const app = document.getElementById('app');
			let minigameTimer;
			function Render(oldState, newState) 
			{
				if (oldState?.currentScreen !== newState.currentScreen || (newState.currentScreen === 'MAIN' && oldState?.player.action !== newState.player.action)) 
				{
					if (window.minigameTimer) clearInterval(window.minigameTimer);
					switch (newState.currentScreen) 
					{
						case 'BOOT':
							RenderScreen('boot-screen-template');
							InitBootScreen();
							break;
						case 'MAIN':
							RenderScreen('main-screen-template');
							InitMainScreen();
							break;
						case 'MINIGAME':
							const templateId = `minigame-${newState.minigame.type.toLowerCase()}-template`;
							RenderScreen(templateId);
							InitMinigame(newState.minigame);
							break;
					}
				}
			}
			function RenderScreen(templateId) 
			{
				const template = document.getElementById(templateId);
				app.innerHTML = '';
				app.appendChild(template.content.cloneNode(true));
			}

			// --- SCREEN INITIALIZERS & LOGIC ---
			function InitBootScreen() 
			{
				const bootText = document.getElementById('boot-text');
				const progressBar = document.getElementById('boot-progress');
				bootText.textContent = 'CONNECTING TO HYPERION PROTOCOL...';
				setTimeout(() => progressBar.style.width = '100%', 100);
				setTimeout(() => UpdateState(s => ({ ...s, currentScreen: 'MAIN' })), 4500);
			}

			function InitMainScreen() 
			{
				const actionDescriptions = {
					OVERCLOCK: 'Divert power to increase reactor stability, risking location damage.',
					REPAIR: 'Perform structural repairs on a damaged location.',
					VENT: 'Vent plasma at a location to mitigate damage from an Overclock.',
				};
				document.getElementById('player-action').textContent = gameState.player.action || 'AWAITING ASSIGNMENT';
				document.getElementById('player-role-desc').textContent = actionDescriptions[gameState.player.action] || 'Stand by for your operational role.';

				const locations = ['Reactor Base', 'Coolant Pool', 'Power Cells', 'Comms Tower'];
				const buttonsContainer = document.getElementById('location-buttons');
				buttonsContainer.innerHTML = locations.map(loc => `
					<button data-location="${loc}" class="location-btn bg-black/30 border-2 border-[var(--green)] rounded-lg p-6 text-lg transition-all duration-200 hover:bg-[var(--green)] hover:text-black">
						${loc}
					</button>
				`).join('');
				buttonsContainer.querySelectorAll('.location-btn').forEach(btn => 
				{
					btn.addEventListener('click', () => 
					{
						const location = btn.dataset.location;
						SendActionToServer('start_action', { location });
					});
				});
			}

			function InitMinigame(minigame) 
			{
				document.getElementById('minigame-prompt').textContent = minigame.prompt;
				let timeLeft = minigame.type === 'SEQUENCE' ? 15 : 10;
				const timerEl = document.getElementById('minigame-timer');
				timerEl.textContent = String(timeLeft);

				window.minigameTimer = setInterval(() => 
				{
					timeLeft--;
					timerEl.textContent = String(timeLeft);
					if (timeLeft <= 0) 
					{
						clearInterval(window.minigameTimer);
						SendActionToServer('minigame_result', { success: false, reason: 'time_out' });
					}
				}, 1000);

				const submitButton = document.getElementById('submit-minigame');
				let finalInput = '';

				if (minigame.type === 'PASSWORD') 
				{
					const input = document.getElementById('password-input');
					input.addEventListener('input', () => 
					{
						finalInput = input.value.toUpperCase();
					});
					input.focus();
				} 
				else if (minigame.type === 'SEQUENCE') 
				{
					const buttonsContainer = document.getElementById('sequence-buttons');
					const display = document.getElementById('sequence-display');
					
					for (let i = 1; i <= 9; i++) 
					{
						const btn = document.createElement('button');
						btn.textContent = String(i);
						btn.className = 'minigame-btn bg-black/50 border-2 border-gray-600 text-2xl p-4 rounded-lg transition-colors hover:bg-gray-700';
						btn.addEventListener('click', () => 
						{
							finalInput += i;
							display.textContent += '*';
						});
						buttonsContainer.appendChild(btn);
					}
				}
				
				submitButton.addEventListener('click', () => 
				{
					clearInterval(window.minigameTimer);
					const success = finalInput === minigame.solution;
					SendActionToServer('minigame_result', { success });
				});
			}
			
			function ShowSolutionPopup(solutionText) 
			{
				const template = document.getElementById('solution-popup-template');
				document.body.appendChild(template.content.cloneNode(true));
				const popupEl = document.body.querySelector('.popup');
				popupEl.querySelector('#solution-text').textContent = solutionText;
				setTimeout(() => 
				{
					popupEl.style.opacity = '1';
					popupEl.style.transform = 'translateY(0)';
				}, 10);
				popupEl.querySelector('#popup-close-btn').addEventListener('click', () => popupEl.remove());
			}

			function TriggerFailureFeedback() 
			{
				console.log("FEEDBACK: Triggering failure screen shake.");
				app.classList.add('animate-shake');
				setTimeout(() => 
				{
					app.classList.remove('animate-shake');
				}, 500);
			}

			// --- GAME LOGIC & SERVER COMMUNICATION ---
			
			function GenerateMinigameData() 
			{
				const isPasswordGame = Math.random() > 0.5;
				const minigameType = isPasswordGame ? 'PASSWORD' : 'SEQUENCE';
				let solution, prompt;
				if (minigameType === 'PASSWORD') 
				{
					const words = ['ALPHA', 'BRAVO', 'DELTA', 'GAMMA', 'OMEGA'];
					solution = words[Math.floor(Math.random() * words.length)];
					prompt = 'Enter Emergency Bypass Code:';
				} 
				else 
				{
					solution = String(Math.floor(100 + Math.random() * 900));
					prompt = 'Input Coolant Frequency Sequence:';
				}
				return { type: minigameType, prompt: prompt, solution: solution };
			}
			
			function SendActionToServer(action, data) 
			{
				console.log(`[TO SERVER] Action: ${action}`, data);
				
				if (action === 'start_action') 
				{
					const minigameData = GenerateMinigameData();
					
					console.log('[TO FIREBASE FOR HELPERS]', {
						actingPlayerId: gameState.player.id,
						actingPlayerName: "Operator",
						...minigameData
					});
					
					setTimeout(() => 
					{
						UpdateState(s => ({ ...s, currentScreen: 'MINIGAME', minigame: minigameData }));
					}, 100);

				} 
				else if (action === 'minigame_result') 
				{
					if (!data.success) 
					{
						TriggerFailureFeedback();
					}
					
					setTimeout(() => 
					{
						UpdateState(s => ({ ...s, currentScreen: 'MAIN' }));
					}, 500);
				}
			}

			// --- MOCK SERVER UPDATES ---
			function MockServerUpdates() 
			{
				setTimeout(() => 
				{
					console.log('[MOCK SERVER] Assigning role...');
					UpdateState(s => ({ ...s, player: { ...s.player, action: 'REPAIR' } }));
				}, 5000);
				setTimeout(() => 
				{
					console.log('[MOCK SERVER] Broadcasting solution for another player...');
					ShowSolutionPopup('Tell Operator 2 the coolant password is "STABILIZE".');
				}, 10000);
			}

			// --- INITIALIZATION ---
			Subscribe(Render);
			MockServerUpdates();
		</script>
	</body>
</html>

